# 2025-11-15 Phase1-重構基礎設施 TODO

**階段：** Phase 1 - Critical Issues（第一週）  
**日期：** 2025年11月15日  
**目標：** 建立基礎設施並消除最嚴重的程式碼問題

---

## ✅ 已完成

### 1. 基礎設施建立
- [x] 建立 `.env.example` 範例環境變數檔案
- [x] 建立 `.env` 實際環境變數檔案（使用當前路徑）
- [x] 建立 `.gitignore` 忽略不需版控的檔案
- [x] 建立 `config.py` 統一設定管理模組
  - [x] PathConfig - 路徑設定
  - [x] CameraConfig - 攝影機設定
  - [x] AnalysisConfig - 分析參數設定
  - [x] LogConfig - 日誌設定
- [x] 建立 `exceptions.py` 自訂例外類別
  - [x] CameraError, CameraOpenError, CameraReadError
  - [x] ModelLoadError
  - [x] AnalysisError
  - [x] ConfigurationError

### 2. 資料模型
- [x] 建立 `models/` 目錄
- [x] 建立 `models/camera_state.py` 攝影機狀態類別
  - [x] 定義 CameraState dataclass
  - [x] 實作 reset() 方法
  - [x] 實作 cache_demographics() 方法
  - [x] 實作 get_elapsed_time() 方法
  - [x] 實作 should_analyze_demographics() 方法
  - [x] 實作 get_emotion_summary() 方法

### 3. 工具模組
- [x] 建立 `utils/` 目錄
- [x] 建立 `utils/logging_config.py` 日誌設定模組
  - [x] 實作 setup_logging() 函式
  - [x] 實作 get_logger() 函式
  - [x] 支援檔案和終端輸出
  - [x] 支援日誌輪替

### 4. 套件管理
- [x] 安裝 python-dotenv
- [x] 安裝 pytest 和 pytest-cov
- [x] 更新 requirements.txt

---

## 🔄 進行中

### 5. 重構 project.py - 消除硬編碼路徑
- [ ] 匯入新建立的模組（config, exceptions, models, utils）
- [ ] 移除硬編碼的模型路徑
- [ ] 移除硬編碼的字體路徑
- [ ] 使用 PathConfig 載入所有路徑
- [ ] 加入路徑驗證邏輯
- [ ] 加入友善的錯誤訊息

### 6. 重構 project.py - 使用 CameraState
- [ ] 建立 camera_states 字典
- [ ] 移除所有全域變數宣告
- [ ] 更新所有引用全域變數的地方
- [ ] 使用 camera_states['customer'] 和 camera_states['server']

### 7. 加入錯誤處理
- [ ] 重構攝影機開啟邏輯
  - [ ] 建立 open_camera_with_retry() 函式
  - [ ] 加入重試機制（最多3次）
  - [ ] 使用 CameraOpenError 例外
- [ ] 重構模型載入邏輯
  - [ ] 檢查檔案存在性
  - [ ] 使用 ModelLoadError 例外
- [ ] 重構 DeepFace 分析邏輯
  - [ ] 區分「沒偵測到臉」和「分析失敗」
  - [ ] 加入重試機制
- [ ] 在主程式加入 try-finally
  - [ ] 確保攝影機正確釋放
  - [ ] 確保視訊寫入器正確釋放

### 8. 加入日誌系統
- [ ] 在主程式初始化日誌
- [ ] 在每個重要模組取得 logger
- [ ] 替換所有 print() 為適當的日誌等級
  - [ ] 一般資訊 → logger.info()
  - [ ] 警告訊息 → logger.warning()
  - [ ] 錯誤訊息 → logger.error()
  - [ ] 除錯資訊 → logger.debug()

---

## 📝 待辦

### 9. 重構 Auto_Switch.py
- [ ] 套用相同的路徑設定邏輯
- [ ] 使用統一的 config 模組
- [ ] 加入錯誤處理
- [ ] 加入日誌系統

### 10. 測試
- [ ] 建立 tests/ 目錄
- [ ] 建立 tests/conftest.py
- [ ] 撰寫 test_camera_state.py
- [ ] 撰寫 test_config.py
- [ ] 執行測試確保重構沒有破壞功能

---

## 🎯 今日目標

完成第 5-8 項任務，確保：
1. ✅ 所有硬編碼路徑被移除
2. ✅ 所有全域變數被封裝進 CameraState
3. ✅ 有完整的錯誤處理機制
4. ✅ 所有輸出使用日誌系統

---

## 📌 注意事項

1. **保持功能不變**：重構過程中確保程式行為完全一致
2. **逐步提交**：完成一個功能就 commit 一次
3. **測試驗證**：每次修改後執行程式確認功能正常
4. **記錄問題**：遇到問題立即記錄在此文件

---

**開始時間：** 2025-11-15 (具體時間待記錄)  
**預計完成時間：** 2025-11-15 晚上

---

## 🔗 相關文件

- [Phase 1 詳細計畫](../plans/phase1.md)
- [程式碼審查報告](../../CODE_REVIEW_IMPROVEMENTS.md)
- [專案結構](../../CLAUDE.md)
