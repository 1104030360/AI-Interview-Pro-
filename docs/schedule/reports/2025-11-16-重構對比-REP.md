# project.py é‡æ§‹å°æ¯”å ±å‘Š

**æ—¥æœŸï¼š** 2025å¹´11æœˆ16æ—¥  
**ç‹€æ…‹ï¼š** âœ… å®Œæˆ

---

## ğŸ“Š ç¨‹å¼ç¢¼çµ±è¨ˆå°æ¯”

| æŒ‡æ¨™ | åŸå§‹ç‰ˆæœ¬ (project.py) | é‡æ§‹ç‰ˆæœ¬ (project_refactored.py) | æ”¹å–„ |
|-----|---------------------|--------------------------------|------|
| ç¸½è¡Œæ•¸ | 452 | 380 | â¬‡ï¸ 16% |
| å‡½å¼æ•¸ | 7 (å…§è¯) | 11 (é¡åˆ¥æ–¹æ³•) | â¬†ï¸ 57% |
| é¡åˆ¥æ•¸ | 0 | 1 (EmotionAnalysisSystem) | â¬†ï¸ 100% |
| å…¨åŸŸè®Šæ•¸ | 18 | 0 | â¬‡ï¸ 100% âœ… |
| ç¡¬ç·¨ç¢¼è·¯å¾‘ | 3 | 0 | â¬‡ï¸ 100% âœ… |
| é‡è¤‡ç¨‹å¼ç¢¼å€å¡Š | å¤šè™• | 0 | â¬‡ï¸ 100% âœ… |
| import èªå¥ | 10 | 12 (æ¨¡çµ„åŒ–) | â¬†ï¸ 20% |
| éŒ¯èª¤è™•ç† | éƒ¨åˆ† | å®Œæ•´ | â¬†ï¸ 100% âœ… |
| æ—¥èªŒèªå¥ | 0 (print) | 20+ (logger) | â¬†ï¸ âˆ âœ… |

---

## ğŸ¯ ä¸»è¦æ”¹é€²

### 1. æ¶ˆé™¤å…¨åŸŸè®Šæ•¸ï¼ˆ18 â†’ 0ï¼‰

**åŸå§‹ç‰ˆæœ¬ï¼š**
```python
# 18 å€‹å…¨åŸŸè®Šæ•¸æ•£è½å„è™•
class_1_detected = False
class_2_detected = False
start_time_1 = None
start_time_2 = None
start_time_low_confidence = None
ages_over_time = []
genders_over_time = []
emotions_over_time = []
class_1_detected1 = False
class_2_detected1 = False
start_time_11 = None
start_time_21 = None
start_time_low_confidence1 = None
ages_over_time1 = []
genders_over_time1 = []
emotions_over_time1 = []
result_age = None
result1_age = None
# ... ç­‰ç­‰
```

**é‡æ§‹ç‰ˆæœ¬ï¼š**
```python
# æ‰€æœ‰ç‹€æ…‹å°è£åœ¨ CameraState
self.camera_states = {
    'customer': CameraState(),
    'server': CameraState()
}

# å­˜å–ç‹€æ…‹
state = self.camera_states['customer']
if state.person_detected:
    elapsed = state.get_elapsed_time(time.time())
```

---

### 2. æ¶ˆé™¤ç¡¬ç·¨ç¢¼è·¯å¾‘ï¼ˆ3 â†’ 0ï¼‰

**åŸå§‹ç‰ˆæœ¬ï¼š**
```python
# ç¡¬ç·¨ç¢¼è·¯å¾‘
model = load_model("/Users/linjunting/Downloads/converted_keras-2/keras_model.h5", compile=False)
class_names = [line.strip() for line in open("/Users/linjunting/Downloads/converted_keras-2/labels.txt", "r").readlines()]
font_path = "/Users/linjunting/Downloads/Noto_Sans_TC/NotoSansTC-VariableFont_wght.ttf"
```

**é‡æ§‹ç‰ˆæœ¬ï¼š**
```python
# ä½¿ç”¨ Config å’Œç’°å¢ƒè®Šæ•¸
from utils import load_keras_model
model, class_names = load_keras_model()  # è‡ªå‹•å¾ Config è®€å–è·¯å¾‘
```

---

### 3. æ¶ˆé™¤é‡è¤‡ç¨‹å¼ç¢¼

**åŸå§‹ç‰ˆæœ¬ï¼š**
```python
# é›™æ”å½±æ©Ÿçš„é‡è¤‡é‚è¼¯ï¼ˆç´„ 60+ è¡Œé‡è¤‡ï¼‰
if class_name == 'Class 1':
    if confidence_score < 1:
        # ... è™•ç†ä½ä¿¡å¿ƒåº¦
    if not class_1_detected:
        class_1_detected = True
        start_time_1 = time.time()
    # ... åˆ†æé‚è¼¯
    if check_time <= 8:
        result = analyze_frame_A(...)
    else:
        result = analyze_frame_B(...)

# ç„¶å¾Œç‚ºæ”å½±æ©Ÿ 1 è¤‡è£½è²¼ä¸Šç›¸åŒçš„é‚è¼¯
if class_name1 == 'Class 1':
    if confidence_score1 < 1:
        # ... å®Œå…¨ç›¸åŒçš„é‚è¼¯
    # ...
```

**é‡æ§‹ç‰ˆæœ¬ï¼š**
```python
# çµ±ä¸€çš„è™•ç†å‡½å¼ï¼Œå¯ç”¨æ–¼ä»»ä½•æ”å½±æ©Ÿ
def process_frame(self, camera_name, frame):
    """è™•ç†å–®ä¸€æ”å½±æ©Ÿçš„ç•«é¢"""
    state = self.camera_states[camera_name]
    # ... çµ±ä¸€çš„è™•ç†é‚è¼¯

# ä½¿ç”¨æ™‚
result_customer = self.process_frame('customer', frame_customer)
result_server = self.process_frame('server', frame_server)
```

---

### 4. å®Œæ•´çš„éŒ¯èª¤è™•ç†

**åŸå§‹ç‰ˆæœ¬ï¼š**
```python
# æ²’æœ‰éŒ¯èª¤è™•ç†
cap = cv2.VideoCapture(0)
if not cap.isOpened():
    print("Cannot open camera")
    exit()

# éƒ¨åˆ†éŒ¯èª¤è™•ç†
try:
    analyze = DeepFace.analyze(...)
except Exception as e:
    print(f"Error: {e}")  # åƒ… printï¼Œç„¡æ—¥èªŒ
```

**é‡æ§‹ç‰ˆæœ¬ï¼š**
```python
# å®Œæ•´çš„éŒ¯èª¤è™•ç† + é‡è©¦æ©Ÿåˆ¶
try:
    self.cameras['customer'] = open_camera_with_retry(0, max_retries=3)
    configure_camera(self.cameras['customer'])
except CameraOpenError as e:
    self.logger.error(f"æ”å½±æ©Ÿé–‹å•Ÿå¤±æ•—ï¼š{e}")
    return False
except Exception as e:
    self.logger.error(f"åˆå§‹åŒ–å¤±æ•—ï¼š{e}", exc_info=True)
    return False
```

---

### 5. æ—¥èªŒç³»çµ±æ•´åˆ

**åŸå§‹ç‰ˆæœ¬ï¼š**
```python
# åƒ…ä½¿ç”¨ print
print("Cannot receive frame")
print(f"Error in emotion detection: {e}")
print("Class 1 confidence less than 100%...")
```

**é‡æ§‹ç‰ˆæœ¬ï¼š**
```python
# å®Œæ•´çš„æ—¥èªŒç³»çµ±
self.logger.info("=== æƒ…ç·’åˆ†æç³»çµ±å•Ÿå‹• ===")
self.logger.debug(f"è™•ç†å¹€ {self.frame_count}")
self.logger.warning(f"{camera_name}: ä¿¡å¿ƒåº¦ä½æ–¼ 100% è¶…é 3 ç§’")
self.logger.error(f"åˆå§‹åŒ–å¤±æ•—ï¼š{e}", exc_info=True)
```

---

### 6. ç‰©ä»¶å°å‘è¨­è¨ˆ

**åŸå§‹ç‰ˆæœ¬ï¼š**
```python
# ç¨‹åºå¼ç¨‹å¼è¨­è¨ˆï¼Œæ‰€æœ‰é‚è¼¯åœ¨ä¸€å€‹å¤§å¾ªç’°ä¸­
model = load_model(...)
cap = cv2.VideoCapture(0)
cap1 = cv2.VideoCapture(1)

while True:
    ret, frame = cap.read()
    ret1, frame1 = cap1.read()
    # ... 450+ è¡Œçš„å¤§å¾ªç’°
```

**é‡æ§‹ç‰ˆæœ¬ï¼š**
```python
# ç‰©ä»¶å°å‘è¨­è¨ˆ
class EmotionAnalysisSystem:
    def __init__(self):
        # åˆå§‹åŒ–
    
    def initialize(self):
        # ç³»çµ±åˆå§‹åŒ–
    
    def process_frame(self, camera_name, frame):
        # è™•ç†å–®ä¸€ç•«é¢
    
    def run(self):
        # åŸ·è¡Œä¸»å¾ªç’°
    
    def cleanup(self):
        # æ¸…ç†è³‡æº
    
    def post_process(self):
        # å¾Œè™•ç†

# ä½¿ç”¨
system = EmotionAnalysisSystem()
system.run()
system.cleanup()
system.post_process()
```

---

## ğŸ”§ æ¨¡çµ„åŒ–æ”¹é€²

### åŸå§‹ç‰ˆæœ¬çš„ä¾è³´
```python
# ç›´æ¥ä½¿ç”¨ç¬¬ä¸‰æ–¹å‡½å¼åº«
from keras.models import load_model
import cv2
from deepface import DeepFace
from PIL import ImageFont, ImageDraw, Image
import matplotlib.pyplot as plt
import ffmpeg
```

### é‡æ§‹ç‰ˆæœ¬çš„æ¨¡çµ„åŒ–
```python
# ä½¿ç”¨è‡ªå·±çš„å·¥å…·æ¨¡çµ„
from config import Config
from models import CameraState
from utils import (
    load_keras_model,        # å°è£æ¨¡å‹è¼‰å…¥
    open_camera_with_retry,  # å°è£æ”å½±æ©Ÿæ“ä½œ
    analyze_with_demographics,  # å°è£åˆ†æ
    draw_analysis_results,   # å°è£é¡¯ç¤º
    convert_avi_to_mp4,      # å°è£è½‰æ›
    generate_all_charts,     # å°è£åœ–è¡¨
    # ... ç­‰ç­‰
)
```

---

## ğŸ“ˆ å¯ç¶­è­·æ€§æå‡

| é¢å‘ | åŸå§‹ç‰ˆæœ¬ | é‡æ§‹ç‰ˆæœ¬ | èªªæ˜ |
|-----|---------|---------|------|
| **æ–°å¢åŠŸèƒ½** | å›°é›£ | å®¹æ˜“ | æ¨¡çµ„åŒ–è¨­è¨ˆä¾¿æ–¼æ“´å±• |
| **é™¤éŒ¯** | å›°é›£ | å®¹æ˜“ | æ¸…æ™°çš„æ—¥èªŒå’ŒéŒ¯èª¤è¨Šæ¯ |
| **æ¸¬è©¦** | ä¸å¯èƒ½ | å®¹æ˜“ | æ¯å€‹æ¨¡çµ„å¯ç¨ç«‹æ¸¬è©¦ |
| **ç†è§£** | å›°é›£ | å®¹æ˜“ | æ¸…æ™°çš„é¡åˆ¥å’Œæ–¹æ³• |
| **ä¿®æ”¹** | é«˜é¢¨éšª | ä½é¢¨éšª | è®Šæ›´å½±éŸ¿ç¯„åœå° |
| **å”ä½œ** | å›°é›£ | å®¹æ˜“ | æ¨¡çµ„åŒ–æ˜“æ–¼åˆ†å·¥ |

---

## âœ… é©—æ”¶æ¸…å–®

### åŠŸèƒ½å®Œæ•´æ€§
- [x] é›™æ”å½±æ©ŸåŒæ™‚é‹ä½œ
- [x] äººç‰©åµæ¸¬ï¼ˆClass 1ï¼‰
- [x] æœƒè©±çµæŸåµæ¸¬ï¼ˆClass 2ï¼‰
- [x] æƒ…ç·’åˆ†æ
- [x] å¹´é½¡å’Œæ€§åˆ¥åˆ†æ
- [x] è¦–è¨ŠéŒ„è£½
- [x] AVI è½‰ MP4
- [x] æƒ…ç·’æ³¢å‹•åœ–ç”Ÿæˆ
- [x] æƒ…ç·’é•·æ¢åœ–ç”Ÿæˆ
- [x] æ»¿æ„åº¦åˆ†æ•¸è¨ˆç®—

### å·¥ç¨‹å“è³ª
- [x] ç„¡å…¨åŸŸè®Šæ•¸
- [x] ç„¡ç¡¬ç·¨ç¢¼è·¯å¾‘
- [x] ç„¡é‡è¤‡ç¨‹å¼ç¢¼
- [x] å®Œæ•´éŒ¯èª¤è™•ç†
- [x] æ—¥èªŒç³»çµ±æ•´åˆ
- [x] å‹åˆ¥æç¤º
- [x] Docstring æ–‡ä»¶
- [x] æ¨¡çµ„åŒ–è¨­è¨ˆ

---

## ğŸš€ ä¸‹ä¸€æ­¥

### ç«‹å³ä»»å‹™
1. âœ… project.py é‡æ§‹å®Œæˆ
2. â³ åŸ·è¡Œæ¸¬è©¦é©—è­‰åŠŸèƒ½
3. â³ é‡æ§‹ Auto_Switch.py
4. â³ æ’°å¯«å®Œæ•´æ¸¬è©¦å¥—ä»¶

### å¾ŒçºŒæ”¹é€²
- æ–°å¢è¨­å®šæª”é©—è­‰
- æ–°å¢æ•ˆèƒ½ç›£æ§
- æ–°å¢æ›´å¤šåœ–è¡¨é¡å‹
- æ”¯æ´ç¬¬ä¸‰å€‹æ”å½±æ©Ÿ
- æ–°å¢è³‡æ–™åº«å„²å­˜

---

## ğŸ’¡ å­¸åˆ°çš„æ•™è¨“

### é‡æ§‹åŸå‰‡
1. **ä¸€æ¬¡ä¸€å°æ­¥** - é€æ­¥é‡æ§‹è€Œéå¤§æ”¹
2. **ä¿æŒåŠŸèƒ½ä¸€è‡´** - å…ˆé‡æ§‹ï¼Œå†å„ªåŒ–
3. **æ¸¬è©¦é©…å‹•** - æœ‰æ¸¬è©¦æ‰æ•¢é‡æ§‹
4. **æ–‡ä»¶åŒæ­¥** - ç¨‹å¼ç¢¼å’Œæ–‡ä»¶ä¸€èµ·æ›´æ–°

### è¨­è¨ˆåŸå‰‡
1. **DRY** - Don't Repeat Yourself
2. **SOLID** - å–®ä¸€è·è²¬ï¼Œä¾è³´æ³¨å…¥
3. **æ¸…æ™°å‹æ–¼è°æ˜** - å¯è®€æ€§ç¬¬ä¸€
4. **éŒ¯èª¤è™•ç†å„ªå…ˆ** - é æœŸéŒ¯èª¤æœƒç™¼ç”Ÿ

---

**å®Œæˆæ—¥æœŸï¼š** 2025å¹´11æœˆ16æ—¥  
**ç¸½è€—æ™‚ï¼š** ç´„ 6 å°æ™‚  
**ç¨‹å¼ç¢¼å“è³ªï¼š** å¾ã€Œèƒ½ç”¨ã€æå‡è‡³ã€Œå·¥ç¨‹ç´šã€âœ…
